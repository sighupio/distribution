# Copyright (c) 2017-present SIGHUP s.r.l All rights reserved.
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE file.

---
- name: Remote Setup - Configure and Deploy on Target Host
  hosts: haproxy
  gather_facts: false

  tasks:
    - name: Wait for haproxy node to be reachable via SSH
      ansible.builtin.wait_for_connection:
        timeout: 300
        sleep: 15

    - name: Install required packages
      apt:
        name:
          - ansible
        state: present
        update_cache: yes

    - name: Copy files to remote host
      ansible.builtin.copy:
        src: "./to_copy/"
        dest: "/root/"
        owner: root
        group: root
        mode: 0755

    - name: Install furyctl
      ansible.builtin.shell: |
        curl -L "https://github.com/sighupio/furyctl/releases/download/{{ furyctl_version }}/furyctl-$(uname -s)-amd64.tar.gz" | tar xz -C /usr/local/bin/
      args:
        creates: /usr/local/bin/furyctl
      vars:
        furyctl_version: "{{ lookup('env', 'FURYCTL_VERSION') | default('v0.34.0-rc.2') }}"

    - name: Create furyctl pki
      ansible.builtin.shell: furyctl create pki -p ./pki
      args:
        chdir: /root
      ignore_errors: yes
      register: furyctl_pki

    - name: Debug furyctl pki creation
      debug:
        msg: "{{ furyctl_pki.stdout }}"

    - name: Run create_ingress_certs.sh
      ansible.builtin.shell: ./create_ingress_certs.sh
      args:
        chdir: /root

    - name: Clone current commit distribution
      ansible.builtin.shell: git clone https://github.com/sighupio/distribution.git /tmp/fury-distribution
      args:
        chdir: /root

    - name: Clone current commit distribution
      ansible.builtin.shell: git checkout {{ commit_sha }}
      args:
        chdir: /tmp/fury-distribution
      vars:
        commit_sha: "{{ lookup('env', 'DRONE_COMMIT_SHA') | default('main') }}"

    # Ubuntu runs unattended-upgrades automatically on fresh nodes,
    # which holds the dpkg lock and can restart sshd. Wait for all nodes
    # to be reachable, then disable the service before furyctl runs.
    - name: Wait for all cluster nodes to be reachable via SSH
      ansible.builtin.shell: >
        ANSIBLE_HOST_KEY_CHECKING=False
        ansible all
        -i "10.10.1.3,10.10.1.4,10.10.1.5,10.10.1.6,10.10.1.7,10.10.1.8,10.10.1.9,10.10.1.10,"
        -m wait_for_connection
        -a "timeout=300 sleep=15"
        -u root

    - name: Disable unattended-upgrades on all cluster nodes before kubernetes installation
      ansible.builtin.shell: >
        ANSIBLE_HOST_KEY_CHECKING=False
        ansible all
        -i "10.10.1.3,10.10.1.4,10.10.1.5,10.10.1.6,10.10.1.7,10.10.1.8,10.10.1.9,10.10.1.10,"
        -m service
        -a "name=unattended-upgrades state=stopped enabled=false"
        -u root
        -e "ansible_python_interpreter=/usr/bin/python3"
      ignore_errors: yes

    - name: Stop apt daily timers on all cluster nodes to prevent unattended-upgrades from re-triggering
      ansible.builtin.shell: >
        ANSIBLE_HOST_KEY_CHECKING=False
        ansible all
        -i "10.10.1.3,10.10.1.4,10.10.1.5,10.10.1.6,10.10.1.7,10.10.1.8,10.10.1.9,10.10.1.10,"
        -m shell
        -a "systemctl stop apt-daily.timer apt-daily-upgrade.timer && systemctl disable apt-daily.timer apt-daily-upgrade.timer"
        -u root
        -e "ansible_python_interpreter=/usr/bin/python3"
      ignore_errors: yes

    - name: Create cluster with furyctl - Kubernetes phase
      ansible.builtin.shell: furyctl apply cluster -o $PWD -D --phase kubernetes --force migrations --distro-location /tmp/fury-distribution
      args:
        chdir: /root
      register: furyctl_kubernetes
      retries: 2
      delay: 60
      until: furyctl_kubernetes.rc == 0

    - name: Debug furyctl kubernetes phase
      debug:
        msg: "{{ furyctl_kubernetes.stdout }}"

    - name: Copy prepare playbook on .furyctl ansible directory
      ansible.builtin.shell: cp 00.prepare-hosts.yaml /root/.furyctl/reevo/kubernetes
      args:
        chdir: /root

    - name: Run ansible prepare (prerequisites for storage)
      ansible.builtin.shell: ansible-playbook 00.prepare-hosts.yaml
      args:
        chdir: /root/.furyctl/reevo/kubernetes

    - name: Complete furyctl installation , all phases + post apply phase
      ansible.builtin.shell: furyctl apply cluster -o $PWD -D --post-apply-phases distribution --force migrations --distro-location /tmp/fury-distribution
      args:
        chdir: /root
      register: furyctl_post_apply
      retries: 2
      delay: 60
      until: furyctl_post_apply.rc == 0

    - name: Debug furyctl with post apply phase
      ansible.builtin.debug:
        msg: "{{ furyctl_post_apply.stdout }}"

    - name: Apply distribution again, in the case storage class is not yet available
      ansible.builtin.shell: sleep 60 && furyctl apply cluster -o $PWD -D --phase distribution --distro-location /tmp/fury-distribution
      args:
        chdir: /root
      register: furyctl_distribution

    - name: Debug furyctl final apply
      ansible.builtin.debug:
        msg: "{{ furyctl_distribution.stdout }}"

    - name: Slurp kubeconfig file
      ansible.builtin.slurp:
        src: "/root/kubeconfig"
      register: kubeconfig_file

    - name: Decode kubeconfig content
      set_fact:
        kubeconfig_decoded: "{{ kubeconfig_file.content | b64decode }}"

    - name: Save kubeconfig to local machine
      ansible.builtin.copy:
        content: "{{ kubeconfig_decoded }}"
        dest: "/cache/kubeconfig"
      delegate_to: localhost
