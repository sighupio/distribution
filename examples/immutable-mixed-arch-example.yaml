# Copyright (c) 2017-present SIGHUP s.r.l All rights reserved.
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE file.
# yaml-language-server: $schema=https://raw.githubusercontent.com/sighupio/distribution/refs/heads/main/schemas/public/immutable-kfd-v1alpha2.json

# Mixed Architecture Kubernetes Cluster Example
# Demonstrates per-node architecture selection for heterogeneous hardware
#
# Use case: Leverage existing x86-64 infrastructure while gradually
# migrating to ARM64 or run cost-effective ARM64 workers alongside
# x86-64 control plane for optimal price/performance

---
apiVersion: kfd.sighup.io/v1alpha2
kind: Immutable
metadata:
  name: mixed-arch-cluster
spec:
  distributionVersion: v1.32.1

  infrastructure:
    ssh:
      username: core
      privateKeyPath: ~/.ssh/id_rsa

    ipxeServer:
      url: https://ipxe.example.com:8080

    nodes:
      # Control Plane: x86-64 (traditional, stable)
      - hostname: ctrl01.k8s.example.com
        macAddress: "52:54:00:10:00:01"
        arch: x86-64  # Explicitly set for clarity
        storage:
          installDisk: /dev/sda
        network:
          ethernets:
            eth0:
              addresses:
                - 192.168.1.10/24
              gateway: 192.168.1.1
              nameservers:
                addresses:
                  - 8.8.8.8
                  - 8.8.4.4

      - hostname: ctrl02.k8s.example.com
        macAddress: "52:54:00:10:00:02"
        arch: x86-64
        storage:
          installDisk: /dev/sda
        network:
          ethernets:
            eth0:
              addresses:
                - 192.168.1.11/24
              gateway: 192.168.1.1
              nameservers:
                addresses:
                  - 8.8.8.8
                  - 8.8.4.4

      - hostname: ctrl03.k8s.example.com
        macAddress: "52:54:00:10:00:03"
        arch: x86-64
        storage:
          installDisk: /dev/sda
        network:
          ethernets:
            eth0:
              addresses:
                - 192.168.1.12/24
              gateway: 192.168.1.1
              nameservers:
                addresses:
                  - 8.8.8.8
                  - 8.8.4.4

      # Load Balancers: x86-64 (lightweight, proven)
      - hostname: lb01.k8s.example.com
        macAddress: "52:54:00:30:00:01"
        arch: x86-64
        storage:
          installDisk: /dev/sda
        network:
          ethernets:
            eth0:
              addresses:
                - 192.168.1.200/24
              gateway: 192.168.1.1
              nameservers:
                addresses:
                  - 8.8.8.8
                  - 8.8.4.4

      - hostname: lb02.k8s.example.com
        macAddress: "52:54:00:30:00:02"
        arch: x86-64
        storage:
          installDisk: /dev/sda
        network:
          ethernets:
            eth0:
              addresses:
                - 192.168.1.202/24
              gateway: 192.168.1.1
              nameservers:
                addresses:
                  - 8.8.8.8
                  - 8.8.4.4

      # Infrastructure Workers: ARM64 (cost-effective for system workloads)
      - hostname: infra01.k8s.example.com
        macAddress: "52:54:00:40:00:01"
        arch: arm64
        storage:
          installDisk: /dev/sda
        network:
          ethernets:
            eth0:
              addresses:
                - 192.168.1.100/24
              gateway: 192.168.1.1
              nameservers:
                addresses:
                  - 8.8.8.8
                  - 8.8.4.4

      - hostname: infra02.k8s.example.com
        macAddress: "52:54:00:40:00:02"
        arch: arm64
        storage:
          installDisk: /dev/sda
        network:
          ethernets:
            eth0:
              addresses:
                - 192.168.1.101/24
              gateway: 192.168.1.1
              nameservers:
                addresses:
                  - 8.8.8.8
                  - 8.8.4.4

      - hostname: infra03.k8s.example.com
        macAddress: "52:54:00:40:00:03"
        arch: arm64
        storage:
          installDisk: /dev/sda
        network:
          ethernets:
            eth0:
              addresses:
                - 192.168.1.102/24
              gateway: 192.168.1.1
              nameservers:
                addresses:
                  - 8.8.8.8
                  - 8.8.4.4

      # Application Workers: Mixed (2 ARM64 + 1 x86-64)
      - hostname: app01.k8s.example.com
        macAddress: "52:54:00:50:00:01"
        arch: arm64  # ARM64 for cost-effective compute
        storage:
          installDisk: /dev/sda
        network:
          ethernets:
            eth0:
              addresses:
                - 192.168.1.110/24
              gateway: 192.168.1.1
              nameservers:
                addresses:
                  - 8.8.8.8
                  - 8.8.4.4

      - hostname: app02.k8s.example.com
        macAddress: "52:54:00:50:00:02"
        arch: arm64
        storage:
          installDisk: /dev/sda
        network:
          ethernets:
            eth0:
              addresses:
                - 192.168.1.111/24
              gateway: 192.168.1.1
              nameservers:
                addresses:
                  - 8.8.8.8
                  - 8.8.4.4

      - hostname: app03.k8s.example.com
        macAddress: "52:54:00:50:00:03"
        arch: x86-64  # x86-64 for workloads requiring specific libraries
        storage:
          installDisk: /dev/sda
        network:
          ethernets:
            eth0:
              addresses:
                - 192.168.1.112/24
              gateway: 192.168.1.1
              nameservers:
                addresses:
                  - 8.8.8.8
                  - 8.8.4.4

  kubernetes:
    version: "1.33.4"

    controlPlane:
      address: 192.168.1.201:6443
      members:
        - hostname: ctrl01.k8s.example.com
          ip: 192.168.1.10
        - hostname: ctrl02.k8s.example.com
          ip: 192.168.1.11
        - hostname: ctrl03.k8s.example.com
          ip: 192.168.1.12

    etcd:
      members:
        - hostname: ctrl01.k8s.example.com
          ip: 192.168.1.10
        - hostname: ctrl02.k8s.example.com
          ip: 192.168.1.11
        - hostname: ctrl03.k8s.example.com
          ip: 192.168.1.12

    loadBalancers:
      enabled: true
      members:
        - hostname: lb01.k8s.example.com
          ip: 192.168.1.200
        - hostname: lb02.k8s.example.com
          ip: 192.168.1.202
      virtualIP: 192.168.1.201

    nodeGroups:
      - name: infra
        nodes:
          - hostname: infra01.k8s.example.com
            ip: 192.168.1.100
          - hostname: infra02.k8s.example.com
            ip: 192.168.1.101
          - hostname: infra03.k8s.example.com
            ip: 192.168.1.102
      - name: workers
        nodes:
          - hostname: app01.k8s.example.com
            ip: 192.168.1.110
          - hostname: app02.k8s.example.com
            ip: 192.168.1.111
          - hostname: app03.k8s.example.com
            ip: 192.168.1.112

    networking:
      podCIDR: 10.244.0.0/16
      serviceCIDR: 10.96.0.0/12

  distribution:
    common:
      nodeSelector:
        node-role.kubernetes.io/infra: ""
      tolerations:
        - key: node-role.kubernetes.io/infra
          operator: Exists
          effect: NoSchedule

    modules:
      networking:
        type: calico

      ingress:
        baseDomain: example.com
        nginx:
          type: single
        certManager:
          clusterIssuer:
            name: letsencrypt-prod
            email: admin@example.com
            type: http01

      logging:
        type: loki

      monitoring:
        type: prometheus

      policy:
        type: kyverno

      dr:
        type: on-premises

      auth:
        provider:
          type: none

# ==================================================================================
# IMPORTANT CONSIDERATIONS FOR MIXED ARCHITECTURE CLUSTERS
# ==================================================================================
#
# 1. CONTAINER IMAGES
#    All workloads MUST use multi-architecture container images.
#    Most official images support multi-arch: nginx, redis, postgres, mysql, etc.
#
#    Check image platforms:
#      docker manifest inspect <image> | jq '.manifests[].platform'
#
#    Build multi-arch images:
#      docker buildx build --platform linux/amd64,linux/arm64 -t myapp:latest --push .
#
# 2. NODE SCHEDULING
#    Kubernetes automatically labels nodes with kubernetes.io/arch
#
#    For architecture-specific workloads, use nodeSelector:
#      nodeSelector:
#        kubernetes.io/arch: amd64  # or arm64
#
#    For flexible scheduling with preferences, use nodeAffinity:
#      affinity:
#        nodeAffinity:
#          preferredDuringSchedulingIgnoredDuringExecution:
#            - weight: 100
#              preference:
#                matchExpressions:
#                  - key: kubernetes.io/arch
#                    operator: In
#                    values: ["arm64"]
#
# 3. ASSET MANAGEMENT
#    furyctl automatically:
#    - Detects architectures in use: [x86-64 arm64]
#    - Downloads only required Flatcar images + sysext packages for those architectures
#    - Generates correct per-node Butane templates with architecture-specific URLs
#
#    Expected asset downloads for this example:
#    - Flatcar artifacts: kernel, initrd, image (x86-64 + arm64)
#    - Sysext packages: containerd, kubernetes, etcd, keepalived (x86-64 + arm64)
#
# 4. PERFORMANCE CONSIDERATIONS
#    - ARM64 typically offers better price/performance for general workloads (up to 40% cost savings)
#    - x86-64 may be required for specific software without ARM64 builds
#    - Test critical workloads on both architectures before production deployment
#    - Consider gradual migration: start with workers, then infra, finally control plane
#
# 5. VERIFICATION
#    After deployment, verify architecture labels:
#      kubectl get nodes -L kubernetes.io/arch
#
#    Check node architecture distribution:
#      kubectl get nodes -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.status.nodeInfo.architecture}{"\n"}{end}'
